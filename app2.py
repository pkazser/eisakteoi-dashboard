import streamlit as st
import pandas as pd
import plotly.express as px

st.set_page_config(page_title="Î”Î™.Î Î‘.Î•. Î‘Î½Î¬Î»Ï…ÏƒÎ· 2024â€“2025", layout="wide")

# === Î•Î¹ÎºÏŒÎ½Î± Î»Î¿Î³Î¿Ï„ÏÏ€Î¿Ï… ===
st.image("dipaelogo.png", width=200)

st.title("ğŸ“Š Î‘Î½Î¬Î»Ï…ÏƒÎ· Î•Î¹ÏƒÎ±ÎºÏ„Î­Ï‰Î½ Î”Î™.Î Î‘.Î•. 2024â€“2025")

# === Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ ===
df = pd.read_csv("dipae_analysis_2024_2025.csv")

# === Sidebar Ï†Î¯Î»Ï„ÏÎ± ===
st.sidebar.header("ğŸ” Î¦Î¯Î»Ï„ÏÎ±")
search = st.sidebar.text_input("Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î¤Î¼Î®Î¼Î±Ï„Î¿Ï‚")

# ÎœÎµÏ„Î±Ï„ÏÎ¿Ï€Î® "ÎšÎ¬Î»Ï…ÏˆÎ·" ÏƒÎµ Î±ÏÎ¹Î¸Î¼Î¿ÏÏ‚ Î³Î¹Î± Ï†Î¹Î»Ï„ÏÎ¬ÏÎ¹ÏƒÎ¼Î±
df["ÎšÎ¬Î»Ï…ÏˆÎ·_2025"] = pd.to_numeric(df["ÎšÎ¬Î»Ï…ÏˆÎ·_2025"], errors="coerce")
df["ÎšÎ¬Î»Ï…ÏˆÎ·_2024"] = pd.to_numeric(df["ÎšÎ¬Î»Ï…ÏˆÎ·_2024"], errors="coerce")
df["Î˜Î­ÏƒÎµÎ¹Ï‚_2025"] = pd.to_numeric(df["Î˜Î­ÏƒÎµÎ¹Ï‚_2025"], errors="coerce")
df["Î˜Î­ÏƒÎµÎ¹Ï‚_2024"] = pd.to_numeric(df["Î˜Î­ÏƒÎµÎ¹Ï‚_2024"], errors="coerce")
df["Î•Ï€Î¹Ï„Ï…Ï‡ÏŒÎ½Ï„ÎµÏ‚_2025"] = pd.to_numeric(df["Î•Ï€Î¹Ï„Ï…Ï‡ÏŒÎ½Ï„ÎµÏ‚_2025"], errors="coerce")
df["Î•Ï€Î¹Ï„Ï…Ï‡ÏŒÎ½Ï„ÎµÏ‚_2024"] = pd.to_numeric(df["Î•Ï€Î¹Ï„Ï…Ï‡ÏŒÎ½Ï„ÎµÏ‚_2024"], errors="coerce")

# Î£Ï„ÏÎ¿Î³Î³Ï…Î»Î¿Ï€Î¿Î¯Î·ÏƒÎ· Ï€Î¿ÏƒÎ¿ÏƒÏ„ÏÎ½ ÎºÎ¬Î»Ï…ÏˆÎ·Ï‚ ÏƒÎµ 2 Î´ÎµÎºÎ±Î´Î¹ÎºÎ¬
df["ÎšÎ¬Î»Ï…ÏˆÎ·_2025"] = df["ÎšÎ¬Î»Ï…ÏˆÎ·_2025"].round(2)
df["ÎšÎ¬Î»Ï…ÏˆÎ·_2024"] = df["ÎšÎ¬Î»Ï…ÏˆÎ·_2024"].round(2)

# Î¦Î¹Î»Ï„ÏÎ¬ÏÎ¹ÏƒÎ¼Î± Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½
if search:
    df_filtered = df[df["ÎŸÎÎŸÎœÎ‘ Î£Î§ÎŸÎ›Î—Î£"].str.contains(search, case=False, na=False)]
else:
    df_filtered = df.copy()

# === Tabs ===
tab1, tab2, tab3, tab4 = st.tabs([
    "ğŸ“‹ Î Î¯Î½Î±ÎºÎ±Ï‚ Î¤Î¼Î·Î¼Î¬Ï„Ï‰Î½", "ğŸ“ˆ Î£ÏÎ³ÎºÏÎ¹ÏƒÎ· ÎšÎ¬Î»Ï…ÏˆÎ·Ï‚", "ğŸ“Š ÎœÏŒÏÎ¹Î± & Î’Î¬ÏƒÎµÎ¹Ï‚", "ğŸ“‘ Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± Î±Î½Î¬ Î¤Î¼Î®Î¼Î±"
])

with tab1:
    st.subheader("ğŸ“‹ Î Î¯Î½Î±ÎºÎ±Ï‚ Î¤Î¼Î·Î¼Î¬Ï„Ï‰Î½ Î”Î™.Î Î‘.Î•.")
    display_cols = [
        "ÎŸÎÎŸÎœÎ‘ Î£Î§ÎŸÎ›Î—Î£",
        "Î˜Î­ÏƒÎµÎ¹Ï‚_2025", "Î•Ï€Î¹Ï„Ï…Ï‡ÏŒÎ½Ï„ÎµÏ‚_2025", "ÎšÎ¬Î»Ï…ÏˆÎ·_2025",
        "Î˜Î­ÏƒÎµÎ¹Ï‚_2024", "Î•Ï€Î¹Ï„Ï…Ï‡ÏŒÎ½Ï„ÎµÏ‚_2024", "ÎšÎ¬Î»Ï…ÏˆÎ·_2024",
        "ÎœÏŒÏÎ¹Î±_Î ÏÏÏ„Î¿Ï…_2025", "Î’Î¬ÏƒÎ·_2025",
        "ÎœÏŒÏÎ¹Î±_Î ÏÏÏ„Î¿Ï…_2024", "Î’Î¬ÏƒÎ·_2024"
    ]
    st.dataframe(df_filtered[display_cols], use_container_width=True)

    # Î ÏÎ¿Î²Î¿Î»Î® ÏƒÏ…Î½ÏŒÎ»Ï‰Î½ Î³Î¹Î± Î˜Î­ÏƒÎµÎ¹Ï‚ ÎºÎ±Î¹ Î•Ï€Î¹Ï„Ï…Ï‡ÏŒÎ½Ï„ÎµÏ‚
    total_2025_positions = df_filtered["Î˜Î­ÏƒÎµÎ¹Ï‚_2025"].sum()
    total_2025_success = df_filtered["Î•Ï€Î¹Ï„Ï…Ï‡ÏŒÎ½Ï„ÎµÏ‚_2025"].sum()
    total_2024_positions = df_filtered["Î˜Î­ÏƒÎµÎ¹Ï‚_2024"].sum()
    total_2024_success = df_filtered["Î•Ï€Î¹Ï„Ï…Ï‡ÏŒÎ½Ï„ÎµÏ‚_2024"].sum()

    st.markdown("### ğŸ“Œ Î£ÏÎ½Î¿Î»Î±")
    st.markdown(f"**2025:** Î˜Î­ÏƒÎµÎ¹Ï‚: {int(total_2025_positions)}, Î•Ï€Î¹Ï„Ï…Ï‡ÏŒÎ½Ï„ÎµÏ‚: {int(total_2025_success)}")
    st.markdown(f"**2024:** Î˜Î­ÏƒÎµÎ¹Ï‚: {int(total_2024_positions)}, Î•Ï€Î¹Ï„Ï…Ï‡ÏŒÎ½Ï„ÎµÏ‚: {int(total_2024_success)}")

    # Î“ÏÎ¬Ï†Î·Î¼Î± Î•Ï€Î¹Ï„Ï…Ï‡ÏŒÎ½Ï„Ï‰Î½
    st.subheader("ğŸ“Š Î£ÏÎ³ÎºÏÎ¹ÏƒÎ· Î•Ï€Î¹Ï„Ï…Ï‡ÏŒÎ½Ï„Ï‰Î½ 2024 vs 2025")
    fig_success = px.bar(df_filtered, x="ÎŸÎÎŸÎœÎ‘ Î£Î§ÎŸÎ›Î—Î£",
                         y=["Î•Ï€Î¹Ï„Ï…Ï‡ÏŒÎ½Ï„ÎµÏ‚_2024", "Î•Ï€Î¹Ï„Ï…Ï‡ÏŒÎ½Ï„ÎµÏ‚_2025"],
                         barmode="group",
                         labels={"value": "Î•Ï€Î¹Ï„Ï…Ï‡ÏŒÎ½Ï„ÎµÏ‚", "variable": "ÎˆÏ„Î¿Ï‚"}, height=600)
    st.plotly_chart(fig_success, use_container_width=True)

with tab2:
    st.subheader("ğŸ“ˆ Î£ÏÎ³ÎºÏÎ¹ÏƒÎ· Î Î¿ÏƒÎ¿ÏƒÏ„Î¿Ï ÎšÎ¬Î»Ï…ÏˆÎ·Ï‚ Î˜Î­ÏƒÎµÏ‰Î½")
    chart_df = df_filtered.dropna(subset=["ÎšÎ¬Î»Ï…ÏˆÎ·_2024", "ÎšÎ¬Î»Ï…ÏˆÎ·_2025"])
    fig = px.bar(chart_df, x="ÎŸÎÎŸÎœÎ‘ Î£Î§ÎŸÎ›Î—Î£", y=["ÎšÎ¬Î»Ï…ÏˆÎ·_2024", "ÎšÎ¬Î»Ï…ÏˆÎ·_2025"], barmode="group",
                 labels={"value": "Î Î¿ÏƒÎ¿ÏƒÏ„ÏŒ ÎšÎ¬Î»Ï…ÏˆÎ·Ï‚", "variable": "ÎˆÏ„Î¿Ï‚"}, height=600)
    st.plotly_chart(fig, use_container_width=True)

with tab3:
    st.subheader("ğŸ¯ Î’Î¬ÏƒÎµÎ¹Ï‚ Î•Î¹ÏƒÎ±Î³Ï‰Î³Î®Ï‚ (Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿Ï…)")
    df_vaseis = df_filtered.dropna(subset=["Î’Î¬ÏƒÎ·_2024", "Î’Î¬ÏƒÎ·_2025"])
    fig3 = px.bar(df_vaseis, x="ÎŸÎÎŸÎœÎ‘ Î£Î§ÎŸÎ›Î—Î£", 
                  y=["Î’Î¬ÏƒÎ·_2024", "Î’Î¬ÏƒÎ·_2025"], barmode="group",
                  labels={"value": "Î’Î¬ÏƒÎ· Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿Ï…", "variable": "ÎˆÏ„Î¿Ï‚"}, height=600)
    st.plotly_chart(fig3, use_container_width=True)

with tab4:
    st.subheader("ğŸ“‘ Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± Î±Î½Î¬ Î¤Î¼Î®Î¼Î±")
    selected_dept = st.selectbox("Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î¤Î¼Î®Î¼Î±", df_filtered["ÎŸÎÎŸÎœÎ‘ Î£Î§ÎŸÎ›Î—Î£"].unique())
    row = df_filtered[df_filtered["ÎŸÎÎŸÎœÎ‘ Î£Î§ÎŸÎ›Î—Î£"] == selected_dept].iloc[0]

    st.markdown(f"### {selected_dept}")

    table_data = {
        "ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±": [
            "Î˜Î­ÏƒÎµÎ¹Ï‚", "Î•Ï€Î¹Ï„Ï…Ï‡ÏŒÎ½Ï„ÎµÏ‚", "ÎšÎ¬Î»Ï…ÏˆÎ· (%)", "ÎœÏŒÏÎ¹Î± Î ÏÏÏ„Î¿Ï…", "Î’Î¬ÏƒÎ·"
        ],
        "2024": [
            int(row['Î˜Î­ÏƒÎµÎ¹Ï‚_2024']),
            int(row['Î•Ï€Î¹Ï„Ï…Ï‡ÏŒÎ½Ï„ÎµÏ‚_2024']),
            f"{row['ÎšÎ¬Î»Ï…ÏˆÎ·_2024']:.2f}%",
            row['ÎœÏŒÏÎ¹Î±_Î ÏÏÏ„Î¿Ï…_2024'],
            row['Î’Î¬ÏƒÎ·_2024']
        ],
        "2025": [
            int(row['Î˜Î­ÏƒÎµÎ¹Ï‚_2025']),
            int(row['Î•Ï€Î¹Ï„Ï…Ï‡ÏŒÎ½Ï„ÎµÏ‚_2025']),
            f"{row['ÎšÎ¬Î»Ï…ÏˆÎ·_2025']:.2f}%",
            row['ÎœÏŒÏÎ¹Î±_Î ÏÏÏ„Î¿Ï…_2025'],
            row['Î’Î¬ÏƒÎ·_2025']
        ],
        "Î”Î¹Î±Ï†Î¿ÏÎ¬": [
            int(row['Î˜Î­ÏƒÎµÎ¹Ï‚_2025'] - row['Î˜Î­ÏƒÎµÎ¹Ï‚_2024']),
            int(row['Î•Ï€Î¹Ï„Ï…Ï‡ÏŒÎ½Ï„ÎµÏ‚_2025'] - row['Î•Ï€Î¹Ï„Ï…Ï‡ÏŒÎ½Ï„ÎµÏ‚_2024']),
            f"{(row['ÎšÎ¬Î»Ï…ÏˆÎ·_2025'] - row['ÎšÎ¬Î»Ï…ÏˆÎ·_2024']):.2f}%",
            row['ÎœÏŒÏÎ¹Î±_Î ÏÏÏ„Î¿Ï…_2025'] - row['ÎœÏŒÏÎ¹Î±_Î ÏÏÏ„Î¿Ï…_2024'],
            row['Î’Î¬ÏƒÎ·_2025'] - row['Î’Î¬ÏƒÎ·_2024']
        ]
    }

    st.table(pd.DataFrame(table_data))

    if pd.notna(row["Î™ÏƒÏ„Î¿ÏƒÎµÎ»Î¯Î´Î± Î¤Î¼Î®Î¼Î±Ï„Î¿Ï‚"]):
        st.markdown(f"[ğŸ”— Î•Ï€Î¯ÏƒÎºÎµÏˆÎ· ÏƒÏ„Î·Î½ Î™ÏƒÏ„Î¿ÏƒÎµÎ»Î¯Î´Î±]({row['Î™ÏƒÏ„Î¿ÏƒÎµÎ»Î¯Î´Î± Î¤Î¼Î®Î¼Î±Ï„Î¿Ï‚']})")
